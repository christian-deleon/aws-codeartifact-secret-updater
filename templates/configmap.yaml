apiVersion: v1
kind: ConfigMap
metadata:
  name: update-codeartifact-secret
data:
  update-codeartifact-secret.sh: |
    #!/bin/sh -e

    echo "Getting authorization token for CodeArtifact"

    TOKEN=$(
      aws codeartifact get-authorization-token \
        --domain {{ .Values.codeartifact.domain }} \
        --domain-owner {{ .Values.aws.accountId }} \
        --region {{ .Values.aws.region }} \
        --query authorizationToken \
        --output text
    )

    NAMESPACES=({{ join " " .Values.namespaces }})

    for ns in $NAMESPACES; do
      echo "Updating secret in namespace: $ns"

      # Create or update the secret
      kubectl create secret generic {{ .Values.secretName }} \
        --from-literal=CODEARTIFACT_TOKEN=$TOKEN \
        --dry-run=client -o yaml | kubectl apply -f - -n $ns

      echo "Secret updated in namespace: $ns"
    done
